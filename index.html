<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Duoplanning ‚Äî Mobile (Firebase)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#58cc02">
  <style>
    :root { 
      --bg:#0f1115; --panel:#151923; --text:#e9eef7; --muted:#a7b1c2; --accent:#58cc02; --border:#273046; 
      --danger:#ff4d4f; --success:#27ae60;
      /* Cores por n√≠vel */
      --lv-tec:#58cc02;      /* T√©cnico */
      --lv-ana:#3aa0ff;      /* Analista */
      --lv-esp:#7e57c2;      /* Especialista */
      --lv-ger:#f2b01c;      /* Gerente/Diretor */
      --lv-vis:#00bcd4;      /* Vision√°rio */
    }
    html,body{width:100%;height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;overflow-x:hidden}
    .wrap{max-width:480px;margin:0 auto;padding:16px}
    h1,h2,h3{margin:0 0 10px;line-height:1.2}
    .hidden{display:none !important}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    input,select,button{font-size:16px;padding:12px;border-radius:10px;border:1px solid var(--border);background:#1b2230;color:var(--text);box-sizing:border-box}
    input,select{width:100%}
    button.primary{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:.25s}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    button.primary:hover{opacity:.9}
    .meta{color:var(--muted);font-size:14px}
    #topBar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    #topBar h1{font-size:20px}
    #topBar .actions{display:flex;gap:8px}
    .xp{display:flex;align-items:center;gap:8px}
    .xpbar{flex:1;height:10px;background:#0e1522;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .xpbar > i{display:block;height:100%;background:var(--accent);width:0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{background:#0e1522;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;position:relative}
    .card h4{margin:0;font-size:15px}
    .badge{font-size:12px;color:#cbd5e1}
    .icon{font-size:22px}
    .ribbon{position:absolute;inset:0 auto 0 0;width:4px;border-radius:14px 0 0 14px;background:var(--accent)}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;background:#0f1722;border:1px solid var(--border)}
    .lv-tec{--lv:var(--lv-tec)} .lv-ana{--lv:var(--lv-ana)} .lv-esp{--lv:var(--lv-esp)} .lv-ger{--lv:var(--lv-ger)} .lv-vis{--lv:var(--lv-vis)}
    .lv .ribbon{background:var(--lv)} .lv .chip{border-color:color-mix(in oklab, var(--lv) 60%, #000 40%)}
    .lv .icon{filter: saturate(1.1)} .lv .primary{background:var(--lv)}
    .mod-footer{display:flex;align-items:center;justify-content:space-between}
    .status{font-size:12px;opacity:.9}
    .status.done{color:var(--success)} .status.lock{color:#94a3b8}
    .lock{position:absolute;right:10px;top:10px;font-size:16px;opacity:.8}
    .card.locked{opacity:.7}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
    .sheet{max-width:480px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .sheet .body{padding:14px}
    .q{font-size:17px;margin:0 0 10px}
    .opts{display:grid;gap:10px}
    .opt{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0d1420;cursor:pointer}
    .opt.correct,.opt.wrong{border-color:var(--border);background:#0d1420}
    .exp{border-left:3px solid var(--accent);padding:8px 12px;margin-top:10px;background:#0f1622}
    .foot{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1722;border:1px solid var(--border);border-radius:999px;padding:10px 14px;color:#fff;display:none;z-index:120}
    @media (max-width:600px){.row{flex-direction:column;align-items:stretch}.grid{grid-template-columns:1fr}.panel{padding:14px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="topBar" class="hidden">
      <h1>Duoplanning</h1>
      <div class="actions">
        <span id="userBadge" class="meta"></span>
        <button id="btnConfig" class="ghost">‚öôÔ∏è</button>
        <button id="btnLogout" class="ghost">Sair</button>
      </div>
    </div>

    <section id="viewLogin" class="panel">
      <h2>Entrar</h2>
      <p class="meta">Entre com Google para salvar seu progresso em nuvem ou use o modo local para testar.</p>
      <div class="row">
        <button id="btnGoogle" class="primary" style="width:100%">Entrar com Google</button>
        <div style="display:flex;align-items:center;gap:8px;width:100%">
          <div style="height:1px;background:var(--border);flex:1"></div>
          <span class="meta">ou</span>
          <div style="height:1px;background:var(--border);flex:1"></div>
        </div>
        <input id="inpName" type="text" placeholder="Seu nome (modo local)" />
        <button id="btnLocal" class="ghost" style="width:100%">Come√ßar (Local)</button>
      </div>
      <p class="meta">Voc√™ come√ßar√° no n√≠vel T√©cnico e desbloqueia os demais por XP.</p>
    </section>

    <section id="viewDash" class="hidden">
      <div class="panel">
        <h2 id="hello">Bem-vindo(a)!</h2>
        <div class="xp">
          <span id="xpText">0 / 1000 XP</span>
          <div class="xpbar"><i id="xpFill"></i></div>
        </div>
      </div>

      <div class="panel">
        <h3>M√≥dulos</h3>
        <div id="legend" class="meta" style="margin:8px 0 12px"></div>
        <div id="mods" class="grid"></div>
      </div>

      <div class="panel">
        <h3>Miss√µes</h3>
        <div class="grid">
          <div class="card lv lv-tec">
            <span class="ribbon"></span>
            <h4>Miss√£o do Dia</h4>
            <div class="meta">Refa√ßa um quiz com 100% (+20 XP)</div>
            <button class="primary" id="btnDaily">Fazer agora</button>
          </div>
          <div class="card lv lv-ana">
            <span class="ribbon"></span>
            <h4>Miss√£o da Semana</h4>
            <div class="meta">Complete 3 m√≥dulos (+100 XP)</div>
            <button class="ghost" disabled>Em breve</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Quiz Modal -->
  <div id="quiz" class="overlay">
    <div class="sheet">
      <div class="head"><strong id="quizTitle">Quiz</strong><button id="btnCloseQuiz" class="ghost">Fechar</button></div>
      <div class="body">
        <div id="qText" class="q">Pergunta</div>
        <div id="opts" class="opts"></div>
        <div id="exp" class="exp hidden"></div>
        <div class="foot">
          <div id="qProg" class="meta">1/10</div>
          <button id="btnNext" class="primary hidden">Avan√ßar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div id="config" class="overlay">
    <div class="sheet">
      <div class="head"><strong>Configura√ß√µes</strong><button id="btnCloseConfig" class="ghost">Fechar</button></div>
      <div class="body">
        <div class="row" style="justify-content:space-between">
          <label style="flex:1">Confete (acertos e aprova√ß√£o)</label>
          <input type="checkbox" id="cfgConfetti" style="flex:0 0 auto;width:auto">
        </div>
        <div class="row" style="justify-content:space-between">
          <label style="flex:1">Som (apenas na aprova√ß√£o)</label>
          <input type="checkbox" id="cfgSound" style="flex:0 0 auto;width:auto">
        </div>
        <div class="row" style="justify-content:space-between">
          <label style="flex:1">Aprova√ß√£o exige ‚â•70%</label>
          <input type="checkbox" id="cfgRequire70" checked style="flex:0 0 auto;width:auto">
        </div>
        <hr style="border-color:var(--border);opacity:.3;margin:12px 0">
        <button id="btnReset" class="ghost">Zerar progresso</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Salvo</div>

  <!-- Firebase + App (module) -->
  <script type="module">
    // ===== Firebase SDKs (v10)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ===== Configura√ß√£o do Firebase (fornecida pelo usu√°rio)
    const firebaseConfig = {
      apiKey: "AIzaSyDAVT6M_mEll69i2S5Btbe2Xpu0gcvB4L4",
      authDomain: "duoplanning-90738.firebaseapp.com",
      projectId: "duoplanning-90738",
      storageBucket: "duoplanning-90738.firebasestorage.app",
      messagingSenderId: "166228868261",
      appId: "1:166228868261:web:441565bc95d238e8d6614c",
      measurementId: "G-24JXV1HEJW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ====== Elementos
    const topBar=document.getElementById('topBar');
    const userBadge=document.getElementById('userBadge');
    const viewLogin=document.getElementById('viewLogin');
    const viewDash=document.getElementById('viewDash');
    const inpName=document.getElementById('inpName');
    const btnLocal=document.getElementById('btnLocal');
    const btnGoogle=document.getElementById('btnGoogle');
    const btnLogout=document.getElementById('btnLogout');
    const btnConfig=document.getElementById('btnConfig');
    const modsEl=document.getElementById('mods');
    const legend=document.getElementById('legend');
    const xpText=document.getElementById('xpText');
    const xpFill=document.getElementById('xpFill');
    const cfgOverlay=document.getElementById('config');
    const cfgConfetti=document.getElementById('cfgConfetti');
    const cfgSound=document.getElementById('cfgSound');
    const cfgRequire70=document.getElementById('cfgRequire70');
    const btnCloseConfig=document.getElementById('btnCloseConfig');
    const btnReset=document.getElementById('btnReset');

    // Modal Quiz
    const quizOverlay=document.getElementById('quiz');
    const quizTitle=document.getElementById('quizTitle');
    const qText=document.getElementById('qText');
    const opts=document.getElementById('opts');
    const exp=document.getElementById('exp');
    const qProg=document.getElementById('qProg');
    const btnNext=document.getElementById('btnNext');
    const btnCloseQuiz=document.getElementById('btnCloseQuiz');

    // ===== Dados de N√≠veis/M√≥dulos
    const LEVELS=[
      {id:'Tecnico',label:'T√©cnico',icon:'üë∑‚Äç‚ôÇÔ∏è',color:'var(--lv-tec)',xp:30},
      {id:'Analista',label:'Analista',icon:'üë®‚Äçüíª',color:'var(--lv-ana)',xp:40},
      {id:'Especialista',label:'Especialista',icon:'üë®‚Äçüîß',color:'var(--lv-esp)',xp:50},
      {id:'Gerente',label:'Gerente/Diretor',icon:'üëî',color:'var(--lv-ger)',xp:60},
      {id:'Visionario',label:'Vision√°rio',icon:'üîÆ',color:'var(--lv-vis)',xp:80}
    ];

    const MODULES = [
      { id: 1,  title: 'LPS ‚Äî Last Planner System',                level: 'Tecnico',     icon: 'üìã', color: 'var(--lv-tec)', xp: 30 },
      { id: 2,  title: 'Cronograma ‚Äî MS Project e EAP',            level: 'Tecnico',     icon: 'üìÜ', color: 'var(--lv-tec)', xp: 30 },
      { id: 3,  title: 'EAP / AWP ‚Äî Pacotes de Trabalho',          level: 'Tecnico',     icon: 'üß©', color: 'var(--lv-tec)', xp: 30 },
      { id: 4,  title: 'Curva S e Rundown ‚Äî Acompanhamento',       level: 'Tecnico',     icon: 'üìà', color: 'var(--lv-tec)', xp: 30 },
      { id: 5,  title: 'Folha Tarefa ‚Äî Gest√£o Di√°ria',             level: 'Tecnico',     icon: 'üóíÔ∏è', color: 'var(--lv-tec)', xp: 30 },
      { id: 6,  title: '√çndices de Produtividade (IPP/ICP)',       level: 'Tecnico',     icon: '‚öôÔ∏è', color: 'var(--lv-tec)', xp: 30 },
      { id: 7,  title: 'Painel de Bordo ‚Äî KPIs Lean',              level: 'Tecnico',     icon: 'üìä', color: 'var(--lv-tec)', xp: 30 },
      { id: 8,  title: 'Waste Time ‚Äî Gest√£o de Esperas',           level: 'Tecnico',     icon: '‚è≥', color: 'var(--lv-tec)', xp: 30 },
      { id: 9,  title: 'Programa√ß√£o Semanal ‚Äî WWP',                level: 'Tecnico',     icon: 'üóìÔ∏è', color: 'var(--lv-tec)', xp: 30 },
      { id:10,  title: 'Lookahead ‚Äî Gest√£o de Restri√ß√µes',         level: 'Tecnico',     icon: 'üîç', color: 'var(--lv-tec)', xp: 30 },
      { id:11,  title: 'Gest√£o Visual ‚Äî Quadros e Andons',         level: 'Tecnico',     icon: 'üñºÔ∏è', color: 'var(--lv-tec)', xp: 30 },
      { id:12,  title: 'Linha de Produ√ß√£o ‚Äî Lean na Obra',         level: 'Tecnico',     icon: 'üèóÔ∏è', color: 'var(--lv-tec)', xp: 30 },
      { id:13,  title: 'Integra√ß√£o Engenharia & Planejamento',     level: 'Analista',    icon: 'üìê', color: 'var(--lv-ana)', xp: 40 },
      { id:14,  title: 'Cronograma Integrado ‚Äî AWP + MSP',         level: 'Analista',    icon: 'üîó', color: 'var(--lv-ana)', xp: 40 },
      { id:15,  title: 'Painel Rundown ‚Äî Curva S Avan√ßada',        level: 'Analista',    icon: 'üìâ', color: 'var(--lv-ana)', xp: 40 },
      { id:16,  title: 'PPC / IPP / ICP ‚Äî Confiabilidade',         level: 'Analista',    icon: '‚úÖ', color: 'var(--lv-ana)', xp: 40 },
      { id:17,  title: 'Pull Planning ‚Äî Colabora√ß√£o',              level: 'Analista',    icon: 'ü§ù', color: 'var(--lv-ana)', xp: 40 },
      { id:18,  title: 'Comissionamento ‚Äî Controle Integrado',     level: 'Analista',    icon: 'üîß', color: 'var(--lv-ana)', xp: 40 },
      { id:19,  title: 'Mobiliza√ß√£o e Desmobiliza√ß√£o',             level: 'Analista',    icon: 'üöö', color: 'var(--lv-ana)', xp: 40 },
      { id:20,  title: 'Pleito T√©cnico ‚Äî Evid√™ncias de Campo',     level: 'Analista',    icon: 'üìÅ', color: 'var(--lv-ana)', xp: 40 },
      { id:21,  title: 'Melhoria Cont√≠nua ‚Äî PDCA',                 level: 'Analista',    icon: '‚ôªÔ∏è', color: 'var(--lv-ana)', xp: 40 },
      { id:22,  title: 'An√°lise de Efetivo ‚Äî Balanceamento',       level: 'Analista',    icon: 'üë•', color: 'var(--lv-ana)', xp: 40 },
      { id:23,  title: 'Lean como Filosofia ‚Äî Cultura',            level: 'Especialista',icon: 'üß†', color: 'var(--lv-esp)', xp: 50 },
      { id:24,  title: 'AWP + BIM 4D ‚Äî Planejamento Visual',       level: 'Especialista',icon: 'üèóÔ∏è', color: 'var(--lv-esp)', xp: 50 },
      { id:25,  title: 'Integra√ß√£o com Power BI ‚Äî KPIs',           level: 'Especialista',icon: 'üìä', color: 'var(--lv-esp)', xp: 50 },
      { id:26,  title: 'Planejamento em Tempo Real ‚Äî Apps',        level: 'Especialista',icon: 'üì±', color: 'var(--lv-esp)', xp: 50 },
      { id:27,  title: 'Lean Digital ‚Äî Automa√ß√£o e IA',            level: 'Especialista',icon: 'ü§ñ', color: 'var(--lv-esp)', xp: 50 },
      { id:28,  title: 'Gargalos ‚Äî Teoria das Restri√ß√µes',         level: 'Especialista',icon: 'üöß', color: 'var(--lv-esp)', xp: 50 },
      { id:29,  title: 'Planejamento Integrado ‚Äî EAP + Custos',    level: 'Especialista',icon: 'üìò', color: 'var(--lv-esp)', xp: 50 },
      { id:30,  title: 'Simula√ß√µes 5D ‚Äî Custo e Produ√ß√£o',         level: 'Especialista',icon: 'üéÆ', color: 'var(--lv-esp)', xp: 50 },
      { id:31,  title: 'An√°lise de Riscos ‚Äî Monte Carlo',          level: 'Especialista',icon: 'üé≤', color: 'var(--lv-esp)', xp: 50 },
      { id:32,  title: 'Lean Office ‚Äî Efici√™ncia Administrativa',  level: 'Especialista',icon: 'üè¢', color: 'var(--lv-esp)', xp: 50 },
      { id:33,  title: 'Lideran√ßa Lean ‚Äî Gest√£o de Pessoas',       level: 'Gerente',     icon: 'üëî', color: 'var(--lv-ger)', xp: 60 },
      { id:34,  title: 'Curva S e Rundown ‚Äî Gerencial',            level: 'Gerente',     icon: 'üìà', color: 'var(--lv-ger)', xp: 60 },
      { id:35,  title: 'AWP com Cronograma Integrado',             level: 'Gerente',     icon: 'üîó', color: 'var(--lv-ger)', xp: 60 },
      { id:36,  title: 'Gest√£o de Indicadores ‚Äî Alta Dire√ß√£o',     level: 'Gerente',     icon: 'üèÜ', color: 'var(--lv-ger)', xp: 60 },
      { id:37,  title: 'Benchmarking ‚Äî Melhores Pr√°ticas',         level: 'Gerente',     icon: 'üåç', color: 'var(--lv-ger)', xp: 60 },
      { id:38,  title: 'Planejamento de Obras Complexas',          level: 'Gerente',     icon: 'üèóÔ∏è', color: 'var(--lv-ger)', xp: 60 },
      { id:39,  title: 'Futuro do Planejamento ‚Äî IA e BIM 5D',     level: 'Visionario',  icon: 'üîÆ', color: 'var(--lv-vis)', xp: 80 },
      { id:40,  title: 'Duoplanning ‚Äî Encerramento da Jornada',    level: 'Visionario',  icon: 'üéì', color: 'var(--lv-vis)', xp: 80 }
    ];

    // ===== Quizzes b√°sicos
    const QUIZ_LPS=[
      {q:'O que significa PPC no LPS?',opts:['Percent Plan Complete','Plano de Produ√ß√£o de Custo','Processo de Controle de Projetos'],ok:0,exp:'PPC mede a confiabilidade dos compromissos semanais.'},
      {q:'Qual ferramenta visual √© usada no LPS semanal?',opts:['Folha Tarefa','Curva S','Diagrama de Rede'],ok:0,exp:'Folha Tarefa registra compromissos/resultado.'},
      {q:'O que o Last Planner busca evitar?',opts:['Improvisos e retrabalhos','Atrasos do cliente','Planejamento de longo prazo'],ok:0,exp:'Foco em estabilidade e fluxo.'},
      {q:'Quem √© o ‚Äú√∫ltimo planejador‚Äù no LPS?',opts:['Quem executa o trabalho','Diretoria','Fornecedor'],ok:0,exp:'S√£o as pessoas que executam e assumem compromissos.'},
      {q:'Qual rotina semanal valida restri√ß√µes?',opts:['Lookahead','Retroplanning','Kanban'],ok:0,exp:'Lookahead identifica e remove restri√ß√µes antes do WWP.'},
      {q:'O que √© PPC de 100% por semanas seguidas?',opts:['Alta confiabilidade','Atraso acumulado','Baixa variabilidade'],ok:0,exp:'Sinal de fluxo previs√≠vel e confi√°vel.'},
      {q:'Registro de restri√ß√µes deve conter‚Ä¶',opts:['Respons√°vel e data','Somente descri√ß√£o','Status financeiro'],ok:0,exp:'Quem resolve e at√© quando.'},
      {q:'Reuni√£o WWP √©‚Ä¶',opts:['Planejamento semanal colaborativo','Balan√ßo de custos','An√°lise trimestral'],ok:0,exp:'Weekly Work Planning √© o compromisso da semana.'},
      {q:'Andon/Quadro visual serve para‚Ä¶',opts:['Transpar√™ncia do status','Controle financeiro','Backup de arquivos'],ok:0,exp:'Torna impedimentos vis√≠veis e trat√°veis.'},
      {q:'Qual indicador apoia causa-raiz de falhas?',opts:['5 Porqu√™s + Pareto','ROI','Lead time financeiro'],ok:0,exp:'T√©cnicas Lean para eliminar recorr√™ncias.'}
    ];
    const QUIZ_CRON=[
      {q:'O que √© Caminho Cr√≠tico?',opts:['Sequ√™ncia sem folga','Tarefas menores','Soma de custos'],ok:0,exp:'Determina a dura√ß√£o total do projeto.'},
      {q:'Qual rela√ß√£o de depend√™ncia mais comum?',opts:['T√©rmino-In√≠cio (FS)','In√≠cio-In√≠cio (SS)','T√©rmino-T√©rmino (FF)'],ok:0,exp:'FS √© a mais utilizada.'},
      {q:'Folga Total igual a 0 indica‚Ä¶',opts:['Atividade cr√≠tica','Atraso leve','Recurso ocioso'],ok:0,exp:'Qualquer atraso impacta o prazo final.'},
      {q:'Linha de Base (Baseline) serve para‚Ä¶',opts:['Comparar planejado x atual','Exportar PDF','Calcular custos indiretos'],ok:0,exp:'Mede varia√ß√µes de prazo.'},
      {q:'WBS/EAP no cronograma significa‚Ä¶',opts:['Estrutura de pacotes','Apenas custos','Apenas riscos'],ok:0,exp:'Organiza hierarquia de atividades.'},
      {q:'Marcos (Milestones) t√™m‚Ä¶',opts:['Dura√ß√£o zero','Dura√ß√£o fixa','Custo fixo'],ok:0,exp:'Eventos de refer√™ncia sem dura√ß√£o.'},
      {q:'Caminho cr√≠tico m√∫ltiplo ocorre quando‚Ä¶',opts:['H√° v√°rias rotas sem folga','H√° folgas negativas','H√° recursos ilimitados'],ok:0,exp:'Mais de uma sequ√™ncia cr√≠tica.'},
      {q:'Leveling de recursos busca‚Ä¶',opts:['Suavizar aloca√ß√µes','Aumentar custo','Criar folgas negativas'],ok:0,exp:'Balancear carga e reduzir picos.'},
      {q:'Calend√°rios no Project definem‚Ä¶',opts:['Dias/turnos v√°lidos','Estrutura da EAP','Integra√ß√£o com SAP'],ok:0,exp:'Disponibilidade de trabalho.'},
      {q:'Caminho cr√≠tico costuma ser destacado por‚Ä¶',opts:['Cor/estilo espec√≠fico','Nomes em mai√∫sculo','Negrito no texto'],ok:0,exp:'Facilita an√°lise visual.'}
    ];
    const QUIZ_EAP=[
      {q:'O que √© EAP?',opts:['Estrutura Anal√≠tica do Projeto','Estrutura Avan√ßada de Produ√ß√£o','Engenharia de An√°lise de Processo'],ok:0,exp:'Divide o escopo em pacotes gerenci√°veis.'},
      {q:'N√≠vel de controle ideal √©‚Ä¶',opts:['Pacote gerenci√°vel (deliverable)','Projeto inteiro','Atividade isolada sem contexto'],ok:0,exp:'Granularidade adequada reduz riscos.'},
      {q:'AWP usa a EAP para‚Ä¶',opts:['Definir CWP/IWP','Medir ROI','Criar curva de custos'],ok:0,exp:'Constr√≥i pacotes alinhados √† execu√ß√£o.'},
      {q:'CWP significa‚Ä¶',opts:['Construction Work Package','Cost Work Plan','Control Work Phase'],ok:0,exp:'Macro pacote de constru√ß√£o.'},
      {q:'IWP significa‚Ä¶',opts:['Installation Work Package','Index of Work Performance','Inside Work Plan'],ok:0,exp:'Pacote execut√°vel no campo.'},
      {q:'Hand‚Äëoff eficiente requer‚Ä¶',opts:['Crit√©rios de pronto','Troca informal','Aprova√ß√£o ad hoc'],ok:0,exp:'Entrada clara entre engenharia, suprimentos e obra.'},
      {q:'Pacotes devem conter‚Ä¶',opts:['Escopo, materiais, seguran√ßa','Somente cronograma','Somente custos'],ok:0,exp:'Conte√∫do m√≠nimo pra execu√ß√£o segura.'},
      {q:'Mapeamento 3D/4D/5D apoia‚Ä¶',opts:['Planejamento integrado','Somente or√ßamento','Somente riscos'],ok:0,exp:'Integra modelagem com prazo e custo.'},
      {q:'Rastreabilidade de revis√µes √© feita em‚Ä¶',opts:['Matriz de vers√µes','E-mail solto','Planilha avulsa'],ok:0,exp:'Controle formal de mudan√ßas.'},
      {q:'AWP melhora principalmente‚Ä¶',opts:['Confiabilidade e produtividade','Somente custo','Somente escopo'],ok:0,exp:'Integra cadeia de valor e reduz esperas.'}
    ];
    const QUIZ_RUNDOWN=[
      {q:'Rundown mostra‚Ä¶',opts:['Plano x Real semanal','Custos diretos','Equipe'],ok:0,exp:'Compara ritmo semanal.'},
      {q:'Base da Curva S?',opts:['Pesos f√≠sicos (HH, ton, m)','Somente custo','Horas extras'],ok:0,exp:'Pesos f√≠sicos por atividade.'},
      {q:'Atualiza√ß√£o do Rundown √©‚Ä¶',opts:['Semanal','Mensal','Trimestral'],ok:0,exp:'Frequ√™ncia padr√£o semanal.'},
      {q:'Indicador para desvio acumulado‚Ä¶',opts:['Varia√ß√£o %/pontos','Tamanho do time','Taxa de c√¢mbio'],ok:0,exp:'Ajuda a priorizar a√ß√µes.'},
      {q:'Lead time do pacote mede‚Ä¶',opts:['Tempo ponta‚Äëa‚Äëponta','Custo total','Horas extras'],ok:0,exp:'Do disparo ao t√©rmino.'},
      {q:'Semaforiza√ß√£o (verde/amarelo/vermelho) √©‚Ä¶',opts:['Gest√£o visual','Controle financeiro','Layout'],ok:0,exp:'Comunica√ß√£o r√°pida do status.'},
      {q:'Causa‚Äëraiz t√≠pica de desvio‚Ä¶',opts:['Restri√ß√£o n√£o removida','Equipe motivada','Meta atingida'],ok:0,exp:'Tratar restri√ß√µes antes.'},
      {q:'Burn‚Äëdown/Burn‚Äëup relaciona‚Ä¶',opts:['Trabalho restante/feito','Custo indireto','Horas extras'],ok:0,exp:'Desempenho ao longo do tempo.'},
      {q:'Acerto de baseline deve‚Ä¶',opts:['Passar por governan√ßa','Ser autom√°tico','Nunca ocorrer'],ok:0,exp:'Mudan√ßas controladas.'},
      {q:'Curva S real acima da planejada indica‚Ä¶',opts:['Adiantamento','Atraso','Sem impacto'],ok:0,exp:'Entrega mais r√°pida que o plano.'}
    ];

    function quizForModule(m){
      if(m.id===1) return QUIZ_LPS;
      if(m.id===2) return QUIZ_CRON;
      if(m.id===3) return QUIZ_EAP;
      if(m.id===4) return QUIZ_RUNDOWN;
      if(m.level==='Tecnico') return QUIZ_LPS;
      if(m.level==='Analista') return QUIZ_CRON;
      if(m.level==='Especialista') return QUIZ_EAP;
      return QUIZ_RUNDOWN;
    }

    // ===== Estado local + sync
    const STATE_KEY='duoplanning.v4.firebase.mobile';
    function baseState(){ return {name:'', xp:0, completed:[], confetti:true, sound:true, require70:true, theme:'dark', lang:'pt', updatedAt: Date.now()}; }
    function loadLocal(){
      try{ const raw = JSON.parse(localStorage.getItem(STATE_KEY)||'null'); if(!raw||typeof raw!=='object') return baseState(); 
        raw.xp = Number.isFinite(+raw.xp)? +raw.xp : 0; 
        if(!Array.isArray(raw.completed)) raw.completed=[];
        raw.confetti = !!raw.confetti; raw.sound=!!raw.sound;
        raw.require70 = raw.require70===undefined ? true : !!raw.require70;
        raw.theme = ['light','dark','system'].includes(raw.theme)? raw.theme : 'dark';
        raw.lang = ['pt','en','es'].includes(raw.lang)? raw.lang : 'pt';
        raw.updatedAt = Number.isFinite(+raw.updatedAt)? +raw.updatedAt : Date.now();
        return raw;
      }catch(e){ return baseState(); }
    }
    let S = loadLocal();
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1600); }

    let syncGuard = { writing:false, lastWrite:0, unsub:null };

    async function saveCloud(){
      if(!auth.currentUser) return;
      try{
        syncGuard.writing = true;
        syncGuard.lastWrite = Date.now();
        const ref = doc(db, "users", auth.currentUser.uid);
        const payload = Object.assign({}, S, { updatedAt: Date.now(), serverUpdatedAt: serverTimestamp() });
        await setDoc(ref, payload, { merge:true });
      } finally {
        // pequena folga para evitar eco de onSnapshot
        setTimeout(()=>{ syncGuard.writing=false; }, 250);
      }
    }
    function saveLocal(){ localStorage.setItem(STATE_KEY, JSON.stringify(S)); }
    function save(){ S.updatedAt = Date.now(); saveLocal(); saveCloud(); }

    function chip(l){return `<span class="chip" style="border-color:${l.color}">${l.icon} ${l.label}</span>`}
    function renderLegend(){ legend.innerHTML = LEVELS.map(chip).join(' '); }
    function cssClassFor(level){ return level==='Tecnico'?'lv-tec':level==='Analista'?'lv-ana':level==='Especialista'?'lv-esp':level==='Gerente'?'lv-ger':'lv-vis'; }
    function completedArr(){ return Array.isArray(S.completed) ? S.completed : []; }

    // Regras de desbloqueio por n√≠vel
    function allIds(from, to){ const a=[]; for(let i=from;i<=to;i++) a.push(i); return a; }
    const TEC_IDS = allIds(1,12);
    const ANA_IDS = allIds(13,22);
    const ESP_IDS = allIds(23,32);
    const GER_IDS = allIds(33,38);
    const VIS_IDS = allIds(39,40);

    function isLevelUnlocked(level){
      const comp = completedArr();
      if(level==='Tecnico') return true;
      if(level==='Analista') return TEC_IDS.every(id=>comp.includes(id));
      if(level==='Especialista') return ANA_IDS.every(id=>comp.includes(id));
      if(level==='Gerente') return ESP_IDS.every(id=>comp.includes(id));
      if(level==='Visionario') return GER_IDS.every(id=>comp.includes(id));
      return false;
    }
    function isLocked(id){ const m = MODULES.find(x=>x.id===id); return !isLevelUnlocked(m.level); }
    function isDone(id){ return completedArr().includes(id); }

    function renderModules(){
      modsEl.innerHTML = MODULES.map(m=>{
        const cls = cssClassFor(m.level);
        const locked = isLocked(m.id);
        const done = isDone(m.id);
        const status = locked ? `<span class='status lock'>üîí Bloqueado</span>` : done ? `<span class='status done'>‚úÖ Conclu√≠do</span>` : `<span class='status'>‚ñ∂Ô∏è Dispon√≠vel</span>`;
        const action = locked ? `<button class='ghost' disabled>Bloqueado</button>` : `<button class='primary' data-mod='${m.id}' style='background:${m.color}'>Fazer Quiz</button>`;
        const lockIcon = locked ? `<div class='lock'>üîí</div>` : '';
        return `<div class='card lv ${cls} ${locked?"locked":""}'>
          <span class='ribbon' style='background:${m.color}'></span>${lockIcon}
          <div class='icon'>${m.icon}</div>
          <h4>${m.title}</h4><div class='mod-footer'>${status} ${action}</div>
        </div>`;
      }).join('');
      modsEl.querySelectorAll('button[data-mod]').forEach(b=>b.addEventListener('click',()=>startQuiz(Number(b.dataset.mod))));
    }
    function renderXP(){ const next=1000; xpText.textContent=`${S.xp} / ${next} XP`; xpFill.style.width=Math.min(100,(S.xp/next)*100)+"%"; }

    function applyTheme(){
      const m = S.theme;
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = (m==='system'? prefersDark : m==='dark');
      document.documentElement.style.setProperty('--bg', dark?'#0f1115':'#f6f8fb');
      document.documentElement.style.setProperty('--panel', dark?'#151923':'#ffffff');
      document.documentElement.style.setProperty('--text', dark?'#e9eef7':'#0f1115');
      document.documentElement.style.setProperty('--muted', dark?'#637089':'#475569');
      document.documentElement.style.setProperty('--border', dark?'#273046':'#dbe1ea');
      document.querySelector('meta[name="theme-color"]').setAttribute('content', dark?'#0f1115':'#ffffff');
    }
    function render(){
      if(!S.name){ topBar.classList.add('hidden'); viewLogin.classList.remove('hidden'); viewDash.classList.add('hidden'); return; }
      topBar.classList.remove('hidden'); viewLogin.classList.add('hidden'); viewDash.classList.remove('hidden');
      document.getElementById('hello').textContent=`Ol√°, ${S.name}!`;
      userBadge.textContent = auth.currentUser ? (auth.currentUser.email || S.name) : 'Modo Local';
      renderLegend(); renderModules(); renderXP(); applyTheme();
    }

    // ====== Login Local (sem nuvem)
    btnLocal.addEventListener('click',()=>{ const v=(inpName.value||'').trim(); if(!v) return; S.name=v; save(); render(); });

    // ====== Login Google (com nuvem)
    btnGoogle.addEventListener('click', async()=>{
      try{
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        // Se n√£o tiver displayName e o usu√°rio preencheu um nome local, aplica no perfil
        if(!user.displayName && (inpName.value||'').trim()){
          await updateProfile(user, { displayName: inpName.value.trim() });
        }
      }catch(err){
        console.error(err);
        toast('Falha no login');
      }
    });

    btnLogout.addEventListener('click', async()=>{
      await signOut(auth);
      // Mant√©m local, mas limpa nome se estava usando nuvem
      if(!S.name) { S = baseState(); saveLocal(); }
      render();
    });

    // ===== Sincroniza√ß√£o em tempo real
    function union(arrA=[], arrB=[]){ return Array.from(new Set([...(arrA||[]), ...(arrB||[])])); }
    async function reconcileWithCloud(cloud){
      // Estrat√©gia: maior XP vence; completed = uni√£o; preferir idioma/tema do cloud (se houver)
      if(cloud){
        const pickXP = Math.max(S.xp||0, cloud.xp||0);
        const pickCompleted = union(S.completed, cloud.completed);
        const prefs = { theme: cloud.theme || S.theme, lang: cloud.lang || S.lang, confetti: (cloud.confetti??S.confetti), sound:(cloud.sound??S.sound), require70:(cloud.require70??S.require70) };
        S = Object.assign({}, S, prefs, { xp: pickXP, completed: pickCompleted, name: cloud.name || S.name });
        saveLocal();
      } else {
        // Se n√£o existe cloud, envia o estado local
        await saveCloud();
      }
      render();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // Atribui nome se local estiver vazio
        if(!S.name){ S.name = user.displayName || (user.email ? user.email.split('@')[0] : 'Usu√°rio'); saveLocal(); }
        // Carrega doc e liga snapshot
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        await reconcileWithCloud(snap.exists()? snap.data() : null);
        if(syncGuard.unsub) syncGuard.unsub();
        syncGuard.unsub = onSnapshot(ref, (docSnap)=>{
          if(syncGuard.writing) return; // ignora eco de escrita local
          if(docSnap.exists()){
            const cloud = docSnap.data();
            // Se o cloud √© mais novo que meu local, aplica
            if((cloud.updatedAt||0) > (S.updatedAt||0)){
              reconcileWithCloud(cloud);
            }
          }
        });
      }else{
        if(syncGuard.unsub){ syncGuard.unsub(); syncGuard.unsub=null; }
        userBadge.textContent = 'Modo Local';
        render();
      }
    });

    // ===== Config Menu Handlers
    btnConfig.addEventListener('click',()=>{
      cfgConfetti.checked = !!S.confetti; cfgSound.checked = !!S.sound; cfgRequire70.checked = !!S.require70; 
      // cria selects se ainda n√£o existirem
      openConfig();
    });
    function openConfig(){
      // Adiciona tema/idioma se n√£o montados
      if(!document.getElementById('cfgTheme')){
        const wrap = document.querySelector('#config .body');
        const hr = wrap.querySelector('hr');
        const theme = document.createElement('div');
        theme.className='row'; theme.style.justifyContent='space-between';
        theme.innerHTML = `<label style="flex:1">Tema</label><select id="cfgTheme" style="flex:0 0 auto;width:auto"><option value="dark">Escuro</option><option value="light">Claro</option><option value="system">Sistema</option></select>`;
        wrap.insertBefore(theme, hr);
        const lang = document.createElement('div');
        lang.className='row'; lang.style.justifyContent='space-between';
        lang.innerHTML = `<label style="flex:1">Idioma</label><select id="cfgLang" style="flex:0 0 auto;width:auto"><option value="pt">Portugu√™s</option><option value="en">English</option><option value="es">Espa√±ol</option></select>`;
        wrap.insertBefore(lang, hr);

        document.getElementById('cfgTheme').addEventListener('change', (e)=>{ S.theme = e.target.value; save(); applyTheme(); });
        document.getElementById('cfgLang').addEventListener('change', (e)=>{ S.lang = e.target.value; save(); render(); });
      }
      document.getElementById('cfgTheme').value = S.theme;
      document.getElementById('cfgLang').value = S.lang;
      cfgOverlay.style.display='flex';
    }
    btnCloseConfig.addEventListener('click',()=> cfgOverlay.style.display='none');
    cfgConfetti.addEventListener('change',()=>{ S.confetti = cfgConfetti.checked; save(); toast('Confete: ' + (S.confetti?'on':'off')); });
    cfgSound.addEventListener('change',()=>{ S.sound = cfgSound.checked; save(); toast('Som: ' + (S.sound?'on':'off')); });
    cfgRequire70.addEventListener('change',()=>{ S.require70 = cfgRequire70.checked; save(); toast('Aprova√ß√£o ‚â•70%: ' + (S.require70?'on':'off')); });
    btnReset.addEventListener('click',()=>{ if(confirm('Zerar progresso?')){ S.xp=0; S.completed=[]; save(); render(); toast('Progresso zerado'); cfgOverlay.style.display='none'; }});

    // ===== Quiz
    let currentModule=null, quizSet=[], qi=0, score=0, resultMode=false;
    function startQuiz(modId){
      if(isLocked(modId)) { toast('Conclua os m√≥dulos do n√≠vel anterior para desbloquear.'); return; }
      currentModule = MODULES.find(m=>m.id===modId);
      const raw = quizForModule(currentModule);
      quizSet = Array.isArray(raw) ? raw.slice(0,10) : [];
      qi=0; score=0; resultMode=false;
      quizTitle.textContent = `${currentModule.icon} ${currentModule.title} ‚Äî ${currentModule.level}`;
      btnNext.style.background = getComputedStyle(document.documentElement).getPropertyValue('--lv-'+cssClassFor(currentModule.level).split('-')[1]) || currentModule.color;
      quizOverlay.style.display='flex';
      renderQ();
    }
    function renderQ(){
      if(!quizSet.length){ qText.textContent='Sem perguntas definidas.'; opts.innerHTML=''; exp.classList.add('hidden'); btnNext.classList.add('hidden'); qProg.textContent='0/0'; return; }
      const Q = quizSet[qi];
      qText.textContent = Q.q;
      qProg.textContent = `${qi+1}/${quizSet.length}`;
      exp.className='exp hidden'; exp.textContent='';
      opts.innerHTML='';
      Q.opts.forEach((txt,idx)=>{
        const el=document.createElement('div'); el.className='opt'; el.textContent=txt;
        el.addEventListener('click',()=>choose(idx));
        opts.appendChild(el);
      });
      btnNext.classList.add('hidden');
    }
    function choose(idx){
      const Q = quizSet[qi];
      [...opts.children].forEach((el,i)=>{ el.classList.add(i===Q.ok?'correct':'wrong'); el.style.pointerEvents='none'; });
      if(idx===Q.ok){
        score++;
        if(S.confetti) confettiMini();
      }
      exp.classList.remove('hidden');
      exp.textContent = Q.exp || '';
      btnNext.classList.remove('hidden');
    }
    function feedbackText(score,total){
      const pct=Math.round((score/total)*100);
      if(pct>=80) return `Excelente! ${score}/${total} (${pct}%).`;
      if(pct>=70) return `Aprovado: ${score}/${total} (${pct}%).`;
      if(pct>=40) return `Ok: ${score}/${total} (${pct}%).`;
      return `Precisa revisar: ${score}/${total} (${pct}%).`;
    }
    btnNext.addEventListener('click',()=>{
      if(resultMode){ quizOverlay.style.display='none'; render(); return; }
      qi++;
      if(qi>=quizSet.length){
        const total = quizSet.length; const pct = Math.round((score/total)*100);
        const require = S.require70 ? 70 : 0;
        const passed = pct >= require;
        if(passed){
          if(!completedArr().includes(currentModule.id)) S.completed.push(currentModule.id);
          const lvl = LEVELS.find(l=>l.id===currentModule.level) || {xp:30};
          S.xp += lvl.xp;
          save();
          if(S.confetti) confettiBurst();
          if(S.sound) victorySound();
        }
        resultMode=true; qProg.textContent='Resultado'; opts.innerHTML=''; exp.classList.add('hidden');
        qText.textContent = feedbackText(score, total) + (passed? ` ‚úÖ Aprovado.` : ` ‚ùå Refa√ßa para concluir.`);
        btnNext.textContent='Concluir';
      } else { renderQ(); }
    });
    btnCloseQuiz.addEventListener('click',()=>{ quizOverlay.style.display='none'; });

    // ===== Confete
    function confettiMini(){
      const canvas = document.createElement('canvas');
      canvas.style.position='fixed'; canvas.style.inset='0'; canvas.style.zIndex='130'; canvas.style.pointerEvents='none';
      document.body.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      const W = canvas.width = window.innerWidth; const H = canvas.height = window.innerHeight;
      const N = 28; const parts=[]; const colors=['#58cc02','#3aa0ff','#7e57c2','#f2b01c','#00bcd4','#ffffff'];
      for(let i=0;i<N;i++) parts.push({x:W/2,y:H/2, r:2+Math.random()*2, dx:(Math.random()-0.5)*8, dy:(Math.random()-1)*8, col:colors[i%colors.length], life:60+Math.random()*40});
      let frame=0; const tick=()=>{
        ctx.clearRect(0,0,W,H);
        for(const p of parts){ p.x+=p.dx; p.y+=p.dy; p.dy+=0.22; p.life--; ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
        frame++; if(frame<90){ requestAnimationFrame(tick);} else { document.body.removeChild(canvas);} };
      tick();
    }
    function confettiBurst(){
      const canvas = document.createElement('canvas');
      canvas.style.position='fixed'; canvas.style.inset='0'; canvas.style.zIndex='130'; canvas.style.pointerEvents='none';
      document.body.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      const W = canvas.width = window.innerWidth; const H = canvas.height = window.innerHeight;
      const N = 150; const parts=[]; const colors=['#58cc02','#3aa0ff','#7e57c2','#f2b01c','#00bcd4','#ffffff'];
      for(let i=0;i<N;i++) parts.push({x:W/2,y:H/3+Math.random()*40,r:2+Math.random()*3,dx:(Math.random()-0.5)*7,dy:Math.random()*-7-2,col:colors[i%colors.length],life:120+Math.random()*60});
      let frame=0; const tick=()=>{
        ctx.clearRect(0,0,W,H);
        for(const p of parts){ p.x+=p.dx; p.y+=p.dy; p.dy+=0.18; p.life--; ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
        frame++; if(frame<220){ requestAnimationFrame(tick);} else { document.body.removeChild(canvas);} };
      tick();
    }
    function victorySound(){
      try{ const AC = window.AudioContext||window.webkitAudioContext; const ac = new AC(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='triangle'; o.frequency.value=660; g.gain.value=0.0001; o.connect(g); g.connect(ac.destination); o.start(); const now=ac.currentTime; g.gain.exponentialRampToValueAtTime(0.2, now+0.02); o.frequency.setValueAtTime(880, now+0.15); g.gain.exponentialRampToValueAtTime(0.0001, now+0.5); o.stop(now+0.55);}catch(e){}
    }

    // ===== Inicializa√ß√£o
    function init(){
      // PWA opcional
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
      render();
    }
    init();
  </script>
</body>
</html>
